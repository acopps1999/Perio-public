# Supabase Schema Update Guide

## Overview

After analyzing the AdminPanel.js and conditions_complete.json files, we've identified additional configurable aspects of the application that should be represented in the Supabase database schema. The updated schema now fully covers all the functionality present in the application.

## New Tables Added

### 1. Research Articles Table
```sql
CREATE TABLE IF NOT EXISTS research_articles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_detail_id BIGINT NOT NULL REFERENCES product_details(id) ON DELETE CASCADE,
    title TEXT,
    author TEXT,
    url TEXT,
    abstract TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```
This table stores research articles associated with products, which can be added through the product details UI in the admin panel.

### 2. Patient-Specific Product Configurations
```sql
CREATE TABLE IF NOT EXISTS patient_specific_configs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    procedure_id BIGINT NOT NULL REFERENCES procedures(id) ON DELETE CASCADE,
    phase_id BIGINT NOT NULL REFERENCES phases(id) ON DELETE CASCADE,
    patient_type_id BIGINT NOT NULL REFERENCES patient_types(id) ON DELETE CASCADE,
    config JSONB,  -- Stores the specific configuration for this combination
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(procedure_id, phase_id, patient_type_id)
);
```
This table stores the patient-specific product configurations for each procedure-phase-patient type combination. The `patientSpecificConfig` data is stored in the JSONB column.

### 3. Phase-Specific Usage Instructions
```sql
CREATE TABLE IF NOT EXISTS phase_specific_usage (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    procedure_id BIGINT NOT NULL REFERENCES procedures(id) ON DELETE CASCADE,
    phase_id BIGINT NOT NULL REFERENCES phases(id) ON DELETE CASCADE,
    instructions TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(product_id, procedure_id, phase_id)
);
```
This table stores phase-specific usage instructions for products, which are managed in the tabbed interface of the product details section.

## Fields Added to Existing Tables

### 1. Procedures Table
Added the following fields to store additional condition metadata:
- `scientific_rationale` - Stores the scientific rationale for the procedure
- `clinical_evidence` - Stores clinical evidence information
- `competitive_advantage` - Stores competitive advantage information
- `handling_objections` - Stores information for handling objections
- `patient_type` - Stores the patient type string (e.g., "Types 1 to 4")

### 2. Product Details Table
Added the following fields:
- `clinical_evidence` - Stores clinical evidence for the product
- `pitch_points` - Stores key pitch points for the product

## Modifications to Junction Tables

1. Added `type_specific` boolean field to `procedure_phase_products` to indicate if a product is marked as "Type 3/4 Only"

## Implementation Strategy

To fully implement this schema in the application:

1. Run the updated SQL schema script in the Supabase SQL editor
2. Modify the `saveToBackend` function in AdminPanel.js to:
   - Save research articles to the new `research_articles` table
   - Save patient-specific configurations to the `patient_specific_configs` table
   - Save phase-specific usage instructions to the `phase_specific_usage` table
   - Include the additional fields when saving procedures and product details

3. Update the data loading logic in the application to:
   - Load research articles and associate them with their respective products
   - Load patient-specific configurations and apply them to the corresponding conditions
   - Load phase-specific usage instructions and apply them to the corresponding products

## Benefits

This updated schema provides several benefits:

1. **Complete Data Model**: All configurable aspects of the application are now represented in the database schema
2. **Improved Querying**: Dedicated tables for complex data like research articles and patient-specific configurations make querying more efficient
3. **Better Relationship Modeling**: Clear relationships between entities make the data model easier to understand and maintain
4. **Future-Proofing**: The schema is now structured to accommodate future enhancements to the application

## Next Steps

After implementing this schema, the next steps would be to:

1. Migrate existing data to the new schema
2. Update the application code to use all new tables and fields
3. Test thoroughly to ensure data integrity and application functionality 